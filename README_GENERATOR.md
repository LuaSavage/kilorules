# Генератор кеша для репозитория

Python скрипт для генерации индексных файлов и файлов кеша для больших файлов репозитория.

## Требования

- Python 3.9.6 или выше
- Стандартная библиотека Python (дополнительные зависимости не требуются)

## Конфигурация

Файл `config.json` содержит настройки путей к файлам:

```json
{
  "base_path": "src/pkg/repository",
  "cache_dir": "cache/cache_data",
  "schema_file": "schema.sql",
  "query_file": "query.sql",
  "generated": {
    "models_sql_go": "generated/models.sql.go",
    "query_sql_go": "generated/query.sql.go",
    "querier_sql_go": "generated/querier.sql.go"
  }
}
```

### Параметры конфигурации:

- `base_path` - базовый путь относительно корня проекта
- `cache_dir` - директория для сохранения кеша (относительно base_path)
- `schema_file` - путь к schema.sql (относительно base_path)
- `query_file` - путь к query.sql (относительно base_path)
- `generated` - объект с путями к сгенерированным Go файлам

## Использование

### Базовое использование:

```bash
python cache_generator.py
```

Скрипт автоматически найдет `config.json` в той же директории.

### С указанием конфигурации:

```bash
python cache_generator.py path/to/config.json
```

## Хеширование файлов

Скрипт автоматически вычисляет SHA256 хеши всех индексируемых файлов и сохраняет их в `cache/cache_data/hashes.json`.

При следующем запуске скрипт проверяет хеши и:
- **Пропускает индексацию** файлов, которые не изменились
- **Обновляет индексы** только для измененных файлов
- **Генерирует кеш** для всех запросов (так как зависимости могут измениться)

## Структура выходных файлов

### Индексные файлы

Создаются в `cache/cache_data/`:
- `schema.sql.index.json` - индекс schema.sql
- `query.sql.index.json` - индекс query.sql
- `models.sql.go.index.json` - индекс generated/models.sql.go
- `query.sql.go.index.json` - индекс generated/query.sql.go
- и т.д.

### Файлы кеша запросов

Создаются в `cache/cache_data/`:
- `{QueryName}.cache.json` - кеш для каждого запроса

### Файл хешей

- `cache/cache_data/hashes.json` - хеши всех отслеживаемых файлов

## Примеры

### Запуск генерации:

```bash
cd src/pkg/repository/cache
python cache_generator.py
```

### Изменение путей в config.json:

Если структура проекта изменилась, просто обновите пути в `config.json`:

```json
{
  "base_path": "new/path/to/repository",
  "schema_file": "database/schema.sql",
  ...
}
```

## Логика работы

1. **Загрузка конфигурации** - чтение путей из config.json
2. **Проверка хешей** - сравнение текущих хешей с сохраненными
3. **Индексация файлов** - только для измененных файлов:
   - schema.sql - таблицы, типы, функции
   - query.sql - SQL запросы
   - generated/*.go - функции, структуры, интерфейсы
4. **Генерация кеша** - для каждого запроса:
   - Извлечение SQL кода
   - Поиск зависимых таблиц
   - Поиск сгенерированного Go кода
5. **Сохранение результатов** - индексы, кеш файлы и хеши

## Примечания

- Скрипт использует относительные пути из config.json относительно base_path
- Хеши вычисляются для полных файлов (SHA256)
- При изменении любого файла все кеш файлы запросов пересоздаются
- Индексы обновляются только для измененных файлов

