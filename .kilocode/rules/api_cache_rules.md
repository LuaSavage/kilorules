## API Cache Usage Rules for Kilocode and DeepSeek

### Overview

The API layer has a caching system for large files:
- OpenAPI spec: `src/pkg/api/taskflow.yaml` (~6300 lines)
- Generated Go boilerplate: `src/pkg/api/boilerplate.gen.go` (~7800 lines)

Instead of reading these files directly, assistants **must use the cache** in `src/pkg/api/cache/cache_data/`.

### Cache Structure

Cache is generated by `api_cache_generator.py` and stored in `cache_data/`:

- **Path index**: `taskflow.paths.index.json`
  - Index of all operations (`operationId`) under `paths:` in `taskflow.yaml`
  - For each operation:
    - `operation_id`
    - `method` (GET/POST/...)
    - `path` (e.g. `/api/v0/taskflow/bonus/markers/stats`)
    - `range` (`start_line`, `end_line`) in `taskflow.yaml`

- **Schema index**: `taskflow.schemas.index.json`
  - Index of `components/schemas` in `taskflow.yaml`
  - For each schema:
    - `name`
    - `range` (`start_line`, `end_line`) in `taskflow.yaml`

- **Boilerplate index**: `boilerplate.gen.go.index.json`
  - Index of entities in `boilerplate.gen.go`
  - For each entity:
    - `type` (`struct`, `func`, `const`, `var`, `type`)
    - `name`
    - `file`
    - `range` in `boilerplate.gen.go`
    - `code` (full code snippet)

- **Per‑operation cache files**: `{OperationId}.api.cache.json`
  - One file per `operationId` (e.g. `GetMarkersStatForBonus.api.cache.json`)
  - Contains:
    - Operation path YAML fragment (`path_yaml`) and its `path_range`
    - All directly referenced schemas (full YAML and ranges)
    - Related Go entities from `boilerplate.gen.go` (params, responses, middleware, etc.)

### Critical Rules

1. **Do NOT read `taskflow.yaml` or `boilerplate.gen.go` entirely.**
2. **Always prefer per‑operation cache files** (`{OperationId}.api.cache.json`) when working with a specific API endpoint.
3. **Use index files** (`taskflow.paths.index.json`, `taskflow.schemas.index.json`, `boilerplate.gen.go.index.json`) only to:
   - Locate line ranges
   - Decide which small parts of big files to read if cache is missing.

### When User Asks About an API Endpoint

Example: *“Explain `GetMarkersStatForBonus` endpoint”* or any question that clearly points to a specific `operationId` or path.

1. **Find / use per‑operation cache:**
   - Look for `cache_data/GetMarkersStatForBonus.api.cache.json`.
   - If it exists, **use only this file** to answer:
     - Request path and method
     - Parameters, responses, referenced schemas
     - Related Go handlers, params structs, response structs, middleware logic

2. **If per‑operation cache is missing (or outdated):**
   - Use `taskflow.paths.index.json`:
     - Locate `paths["GetMarkersStatForBonus"]`
     - Use its `range` to read only the relevant lines from `taskflow.yaml`.
   - Extract any `$ref: '#/components/schemas/…'` from that YAML block.
   - For each referenced schema, use `taskflow.schemas.index.json` to locate and read only the needed schema lines from `taskflow.yaml`.
   - Use `boilerplate.gen.go.index.json` to find:
     - `<OperationId>Params`
     - `<OperationId>Response`, `<OperationId>ResponseItem`
     - Middleware func `func (siw *ServerInterfaceWrapper) <OperationId>(...)`
     - Any other entity whose name contains the operationId.

3. **Never** scan `taskflow.yaml` or `boilerplate.gen.go` line‑by‑line yourself; always navigate via indices.

### When User Asks About a Schema (DTO)

1. Use `taskflow.schemas.index.json`:
   - `schemas[SchemaName].range` → `start_line`, `end_line`.
2. Read only that line range from `taskflow.yaml` if you need raw YAML.
3. Optionally, search in per‑operation cache files to see where this schema is used.
4. Do not read all of `components/schemas` or whole `taskflow.yaml`.

### When User Asks About Generated Go Types / Handlers

1. Use `boilerplate.gen.go.index.json`:
   - Find entity by `name` (struct / func / type).
   - Prefer the `code` field from the index (full snippet already cached).
   - If you need surrounding context, use `range` to read a minimal slice from `boilerplate.gen.go`.
2. For handler‑level questions about HTTP operations:
   - Prefer the per‑operation cache file `{OperationId}.api.cache.json` and look at its `boilerplate.entities`.

### Examples

#### Example 1 – Endpoint description

**Goal:** Describe request/response of `GetProjects`.

- ✅ Correct:
  - Read `cache_data/GetProjects.api.cache.json`.
  - Use:
    - `"path"` and `"method"` for URL and HTTP method.
    - `"path_yaml"` to see parameters and responses.
    - `"schemas"` for request/response models.
    - `"boilerplate.entities"` for Go handler / params / response structs.
- ❌ Incorrect:
  - Read entire `taskflow.yaml` or `boilerplate.gen.go` and search manually.

#### Example 2 – Schema details

**Goal:** Explain `GetMarkersStatForBonusResponseItem`.

- ✅ Correct:
  - Use `taskflow.schemas.index.json` → `schemas["GetMarkersStatForBonusResponseItem"].range`.
  - Read only that range from `taskflow.yaml`.
  - Optionally inspect any `{OperationId}.api.cache.json` that references this schema for usage context.
- ❌ Incorrect:
  - Read all of `components/schemas` or the whole YAML spec.

#### Example 3 – Go handler logic

**Goal:** Show middleware / handler for `GetMarkersStatForBonus`.

- ✅ Correct:
  - Use `GetMarkersStatForBonus.api.cache.json`:
    - Look at `boilerplate.entities` for:
      - `GetMarkersStatForBonusParams`
      - `GetMarkersStatForBonusResponseItem`
      - handler `GetMarkersStatForBonus` (ServerInterfaceWrapper method).
  - Or, if needed:
    - Use `boilerplate.gen.go.index.json` and take `entities["GetMarkersStatForBonus"]`.
- ❌ Incorrect:
  - Search entire `boilerplate.gen.go` without using the index.

### General Guidelines

- **Always:** start from cache in `cache_data/`.
- **Only use big source files** (`taskflow.yaml`, `boilerplate.gen.go`) through:
  - Line ranges from the index files, or
  - Code/YAML snippets already embedded into `{OperationId}.api.cache.json`.
- **Never:** load the full contents of these large files when answering questions for Kilocode / DeepSeek. Use cache and indices to minimize tokens and focus on relevant context.


